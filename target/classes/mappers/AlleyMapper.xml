<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bowling.mapper.AlleyMapper">

	<!-- 볼링장 등록 -->
	<insert id="alleyRegister">
		INSERT INTO alley
		(ALLEY_SEQ, ALLEY_TEL, ALLEY_NAME, OPEN_TIME, CLOSE_TIME, PRICE_NOMARL, PRICE_CLUB, PRICE_STUDENT, ALLEY_ZIP_CODE, ALLEY_ADDR1, ALLEY_ADDR2, ALLEY_RAIN, ALLEY_CONTENT, FIRST_REGIST_TM, FIRST_REGIST_ID, LAST_UPDT_TM, LAST_UPDT_ID)
		VALUES (NULL, #{alleyTel}, #{alleyName}, #{openTime}, #{closeTime}, #{priceNomarl}, #{priceClub}, #{priceStudent}, #{alleyZipCode}, #{alleyAddr1}, #{alleyAddr2}, #{alleyRain},#{alleyContent} ,NOW(), #{firstRegistId}, NOW(), #{lastUpdtId})
	</insert>
	
	<!-- 볼링장 리스트 -->
	
    <select id="alleyList" resultMap="AlleyVO">
       select  ALLEY_NAME, ALLEY_ADDR1,ALLEY_ADDR2, ALLEY_TEL, OPEN_TIME, CLOSE_TIME,PRICE_NOMARL,PRICE_CLUB,PRICE_STUDENT,ALLEY_SEQ
       from ALLEY 
       order by ALLEY_SEQ DESC 
    </select>
	
<!-- 	<select id="alleyList" resultMap="AlleyVO"> -->
<!-- 		<![CDATA[ -->
<!--           SELECT * FROM ( -->
<!--               SELECT /*+INDEX_DESC(ALLEY ALLEY_PK) */  -->
<!--                   ROWNUM AS RN, ALLEY_NAME, ALLEY_ADDR2, ALLEY_TEL, OPEN_TIME, CLOSE_TIME, PRICE_NOMARL, PRICE_CLUB, PRICE_STUDENT, ALLEY_SEQ -->
<!--             FROM ALLEY  -->
<!--             WHERE -->
             
<!--     	]]>          -->
<!--             <if test="keyword != null"> -->
<!--                 ALLEY_NAME LIKE '%'||#{keyword}||'%' AND -->
<!--             </if> -->
            
<!--     	<![CDATA[         -->
<!--              ROWNUM <= #{pageNum}*#{amount} -->

<!--             ) -->
<!--         WHERE RN > (#{pageNum} - 1) * #{amount} ORDER BY ALLEY_SEQ DESC -->
<!--       	]]> -->
      		
<!-- 	</select> -->
	
	
	
	<select id="alleyTotal" resultType="int">
		SELECT COUNT(*) FROM ALLEY
		
		<if test="keyword !=null">
			WHERE ALLEY_NAME LIKE '%'||#{keyword}||'%'		
		</if>
	</select>
	
	
	
	<!-- 볼리장 상세 페이지 -->
	<select id="alleyDetail" parameterType="int" resultMap="AlleyVO">
		SELECT ALLEY_SEQ, ALLEY_TEL, ALLEY_NAME, OPEN_TIME, CLOSE_TIME, PRICE_NOMARL, PRICE_CLUB, PRICE_STUDENT, ALLEY_ZIP_CODE, ALLEY_ADDR1, ALLEY_ADDR2, ALLEY_RAIN, ALLEY_CONTENT, FIRST_REGIST_TM, FIRST_REGIST_ID, LAST_UPDT_TM, LAST_UPDT_ID
		FROM alley
		WHERE ALLEY_SEQ = #{alleySeq}		
	</select>
	
	
	<!-- 볼링장 정보 수정 -->
	<update id="alleyModify">
		UPDATE ALLEY
		SET ALLEY_TEL = #{alleyTel}, ALLEY_NAME = #{alleyName}, OPEN_TIME = #{openTime},
			CLOSE_TIME = #{closeTime}, PRICE_NOMARL = #{priceNomarl}, PRICE_CLUB = #{priceClub}, PRICE_STUDENT = #{priceStudent},
			ALLEY_ZIP_CODE=#{alleyZipCode}, ALLEY_ADDR1 = #{alleyAddr1}, ALLEY_ADDR2 = #{alleyAddr2}, ALLEY_RAIN = #{alleyRain}, ALLEY_CONTENT = #{alleyContent}
			LAST_UPDT_TM=NOW(), LAST_UPDT_ID=#{memberId}
		WHERE ALLEY_SEQ = #{alleySeq}	
	</update>
	
	<!-- 볼링장 정보 삭제 -->
	<delete id="alleyDelete">
		DELETE FROM ALLEY WHERE ALLEY_SEQ = #{alleySeq}
	</delete>
	
	<!-- 이미지 등록 -->
	<insert id="imageRegister">
		
		INSERT INTO IMAGE(ALLEY_SEQ,FILE_NAME,UPLOAD_PATH,UUID) VALUES (#{alleySeq},#{fileName},#{uploadPath},#{uuid})
	
	</insert>
	
	<!-- 지정 볼링장 이미지 전체 삭제 -->
	<delete id="deleteImageAll">
		DELETE FROM IMAGE WHERE ALLEY_SEQ = #{alleySeq}
	</delete>
	
	
	<!-- 볼링장별 회원등급 조회 -->
	<select id="alleyMemberGrade" resultType="String">
		SELECT ALLEY_MEMBER_GRADE FROM alley_member_grade
		WHERE MEMBER_ID = #{memberId} and ALLEY_SEQ = #{alleySeq}
	</select>
	
	<!-- 회원등급 조건 체크 -->
	<select id="MemberGradeCk" resultType="int">
		SELECT COUNT(DISTINCT BO_DATE) FROM BOOKING
		WHERE DATE_ADD(NOW(), INTERVAL -3 MONTH) AND MEMBER_ID = #{memberId} AND alley_seq = #{alleySeq}
	</select>
	
	
<!-- 	<select id="searchAlleyInfo" resultMap="AlleyVO"> -->
<!-- 		<choose> -->
<!-- 			<when test="boTime != null and boDate != null and (alleyName != null or localName != null)"> -->
<!-- 				SELECT (b.PUBLIC_CNT+ b.CLUB_CNT+ b.STUDENT_CNT) AS total,b.ALLEY_SEQ ,a.ALLEY_NAME,(a.ALLEY_RAIN*5) AS allowPerson,a.ALLEY_ADDR1,a.ALLEY_ADDR2, a.ALLEY_TEL, a.OPEN_TIME, a.CLOSE_TIME -->
<!-- 				FROM booking b -->
<!-- 				LEFT JOIN alley a ON b.ALLEY_SEQ = a.ALLEY_SEQ -->
<!-- 				WHERE b.BO_TIME = #{boTime} AND b.BO_DATE = #{boDate} AND (a.ALLEY_NAME LIKE '%'||#{alleyName}||'%' OR a.ALLEY_ADDR1 LIKE '%'||#{localName}||'%') -->
<!-- 				order by ALLEY_SEQ DESC -->
<!-- 			</when> -->
<!-- 			<otherwise> -->
<!-- 				select  ALLEY_NAME, ALLEY_ADDR1,ALLEY_ADDR2, ALLEY_TEL, OPEN_TIME, CLOSE_TIME,PRICE_NOMARL,PRICE_CLUB,PRICE_STUDENT,ALLEY_SEQ -->
<!-- 		        from ALLEY  -->
<!-- 		        order by ALLEY_SEQ DESC  -->
<!-- 			</otherwise> -->
<!-- 		</choose> -->
<!-- 	</select> -->
	
	
	<select id="searchAlleyInfo" resultMap="AlleyVO">
		SELECT *
		FROM alley
		WHERE ALLEY_SEQ NOT IN (
		SELECT a.ALLEY_SEQ from
		(SELECT (b.PUBLIC_CNT+ b.CLUB_CNT+ b.STUDENT_CNT) AS total, b.ALLEY_SEQ , a.ALLEY_NAME,(a.ALLEY_RAIN*5) AS allowPerson
		FROM booking b
		LEFT JOIN alley a ON b.ALLEY_SEQ = a.ALLEY_SEQ
		WHERE b.BO_TIME = #{boTime} AND b.BO_DATE = #{boDate} AND (a.ALLEY_NAME LIKE '%'||#{alleyName}||'%' OR a.ALLEY_ADDR1 LIKE '%'||#{localName}||'%')
		) a
		WHERE total > allowPerson
		)
	</select>
	
	
	<resultMap id="AlleyVO" type="com.bowling.domain.vo.AlleyVO">
      <result property="alleySeq" column="ALLEY_SEQ" />
      <result property="alleyTel" column="ALLEY_TEL" />
      <result property="alleyName" column="ALLEY_NAME" />
      <result property="openTime" column="OPEN_TIME" />
      <result property="closeTime" column="CLOSE_TIME" />
      <result property="priceNomarl" column="PRICE_NOMARL" />
      <result property="priceClub" column="PRICE_CLUB" />
      <result property="priceStudent" column="PRICE_STUDENT" />
      <result property="alleyZipCode" column="ALLEY_ZIP_CODE" />
      <result property="alleyAddr1" column="ALLEY_ADDR1" />
      <result property="alleyAddr2" column="ALLEY_ADDR2" />
      <result property="alleyRain" column="ALLEY_RAIN" />
      <result property="alleyContent" column="ALLEY_CONTENT" />
      <result property="firstRegistTm" column="FIRST_REGIST_TM" />
      <result property="firstRegistId" column="FIRST_REGIST_ID" />
      <result property="lastUpdtTm" column="LAST_UPDT_TM" />
      <result property="lastUpdtId" column="LAST_UPDT_ID" />
      <result property="total" column="total" />
      <result property="allowPerson" column="allowPerson" />
   </resultMap>
   
   <resultMap id="AlleyMemberGradeVO" type="com.bowling.domain.vo.AlleyMemberGradeVO">
      <result property="alleySeq" column="ALLEY_SEQ" />
      <result property="memberId" column="MEMBER_ID" />
      <result property="alleyMemberGrade" column="ALLEY_MEMBER_GRADE" />
      <result property="alleyName" column="ALLEY_NAME" />
   </resultMap>
   




</mapper>